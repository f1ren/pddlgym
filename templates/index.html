<!-- query.html -->
<html>
<head>
    <title>Query</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.0/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css" integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e" crossorigin="anonymous">
    <script>
        $(document).ready(function() {
            // Send the form on enter keypress and avoid if shift is pressed
            $('#prompt').keypress(function(event) {
                if (event.keyCode === 13 && !event.shiftKey) {
                    event.preventDefault();
                    $('form').submit();
                }
            });
            $('form').on('submit', function(event) {
                event.preventDefault();
            // get the CSRF token from the cookie
            var csrftoken = Cookies.get('csrftoken');

            // set the CSRF token in the AJAX headers
            $.ajaxSetup({
                headers: { 'X-CSRFToken': csrftoken }
            });
                // Get the prompt
                var prompt = $('#prompt').val();
                var dateTime = new Date();
                var time = dateTime.toLocaleTimeString();
                // Add the prompt to the response div
                $('#response').append('<p id="GFG1">('+ time + ') <i class="bi bi-person"></i>: ' + prompt + '</p>');
                $('#response #GFG1').css({"color": "green", "width": "95%"});
                var d = $('#response');
                d.scrollTop(d.prop("scrollHeight"));
                // Clear the prompt
                $('#prompt').val('');
                $.ajax({
                    url: '/',
                    type: 'POST',
                    data: {prompt: prompt},
                    dataType: 'json',
                    success: function(data) {
                        $('#response').append('<p id="GFG2">('+ time + ') <i class="bi bi-robot"></i>: ' + marked.parse(data.response) + '</p>');
                        $('#response #GFG2').css({"color": "red", "width": "95%"});
                        d.scrollTop(d.prop("scrollHeight"));
                    }
                });
            });

            setInterval(() => {
                fetch('http://127.0.0.1:5000/simulation?time=' + new Date())
                    .then(response => response.blob())
                    .then(blob => {
                        let url = URL.createObjectURL(blob);
                        let img = document.querySelector('img');
                        img.src = url;
                    })
                    .catch(e => console.error(e));
            }, 500);

        });
    </script>
</head>
<body>
    <div class="container p-3 row">
        <h3>PDDL Dialog</h3>
        <div class="container col-9">
            <div class="mb-3">
                <h6>Problem and domain</h6>
                <div class="container border overflow-scroll" id="response" style="height: 450px"><pre>(define (problem p024-microban-sequential) 
  (:domain sokoban)
  (:objects
        dir-down - direction
    dir-left - direction
    dir-right - direction
    dir-up - direction
    player-01 - thing
    pos-1-1 - location
    pos-1-2 - location
    pos-1-3 - location
    pos-1-4 - location
    pos-1-5 - location
    pos-1-6 - location
    pos-1-7 - location
    pos-2-1 - location
    pos-2-2 - location
    pos-2-3 - location
    pos-2-4 - location
    pos-2-5 - location
    pos-2-6 - location
    pos-2-7 - location
    pos-3-1 - location
    pos-3-2 - location
    pos-3-3 - location
    pos-3-4 - location
    pos-3-5 - location
    pos-3-6 - location
    pos-3-7 - location
    pos-4-1 - location
    pos-4-2 - location
    pos-4-3 - location
    pos-4-4 - location
    pos-4-5 - location
    pos-4-6 - location
    pos-4-7 - location
    pos-5-1 - location
    pos-5-2 - location
    pos-5-3 - location
    pos-5-4 - location
    pos-5-5 - location
    pos-5-6 - location
    pos-5-7 - location
    pos-6-1 - location
    pos-6-2 - location
    pos-6-3 - location
    pos-6-4 - location
    pos-6-5 - location
    pos-6-6 - location
    pos-6-7 - location
    pos-7-1 - location
    pos-7-2 - location
    pos-7-3 - location
    pos-7-4 - location
    pos-7-5 - location
    pos-7-6 - location
    pos-7-7 - location
    stone-01 - thing
  )
  (:goal (and
    (at-goal stone-01)))
  (:init 
    (at player-01 pos-6-3)
    (at stone-01 pos-4-3)
    (clear pos-1-2)
    (clear pos-2-1)
    (clear pos-2-2)
    (clear pos-2-4)
    (clear pos-2-5)
    (clear pos-2-6)
    (clear pos-3-4)
    (clear pos-3-5)
    (clear pos-3-6)
    (clear pos-4-2)
    (clear pos-4-4)
    (clear pos-4-5)
    (clear pos-4-6)
    (clear pos-5-2)
    (clear pos-5-5)
    (clear pos-5-6)
    (clear pos-6-2)
    (clear pos-6-5)
    (clear pos-6-6)
    (is-goal pos-3-6)
    (is-nongoal pos-1-1)
    (is-nongoal pos-1-2)
    (is-nongoal pos-1-3)
    (is-nongoal pos-1-4)
    (is-nongoal pos-1-5)
    (is-nongoal pos-1-6)
    (is-nongoal pos-1-7)
    (is-nongoal pos-2-1)
    (is-nongoal pos-2-2)
    (is-nongoal pos-2-3)
    (is-nongoal pos-2-4)
    (is-nongoal pos-2-5)
    (is-nongoal pos-2-6)
    (is-nongoal pos-2-7)
    (is-nongoal pos-3-1)
    (is-nongoal pos-3-2)
    (is-nongoal pos-3-3)
    (is-nongoal pos-3-4)
    (is-nongoal pos-3-5)
    (is-nongoal pos-3-7)
    (is-nongoal pos-4-1)
    (is-nongoal pos-4-2)
    (is-nongoal pos-4-3)
    (is-nongoal pos-4-4)
    (is-nongoal pos-4-5)
    (is-nongoal pos-4-6)
    (is-nongoal pos-4-7)
    (is-nongoal pos-5-1)
    (is-nongoal pos-5-2)
    (is-nongoal pos-5-3)
    (is-nongoal pos-5-4)
    (is-nongoal pos-5-5)
    (is-nongoal pos-5-7)
    (is-nongoal pos-6-1)
    (is-nongoal pos-6-2)
    (is-nongoal pos-6-3)
    (is-nongoal pos-6-4)
    (is-nongoal pos-6-5)
    (is-nongoal pos-6-6)
    (is-nongoal pos-6-7)
    (is-nongoal pos-7-1)
    (is-nongoal pos-7-2)
    (is-nongoal pos-7-3)
    (is-nongoal pos-7-4)
    (is-nongoal pos-7-5)
    (is-nongoal pos-7-6)
    (is-nongoal pos-7-7)
    (is-player player-01)
    (is-stone stone-01)
    (move dir-down)
    (move dir-left)
    (move dir-right)
    (move dir-up)
    (move-dir pos-1-2 pos-2-2 dir-right)
    (move-dir pos-2-1 pos-2-2 dir-down)
    (move-dir pos-2-2 pos-1-2 dir-left)
    (move-dir pos-2-2 pos-2-1 dir-up)
    (move-dir pos-2-4 pos-2-5 dir-down)
    (move-dir pos-2-4 pos-3-4 dir-right)
    (move-dir pos-2-5 pos-2-4 dir-up)
    (move-dir pos-2-5 pos-2-6 dir-down)
    (move-dir pos-2-5 pos-3-5 dir-right)
    (move-dir pos-2-6 pos-2-5 dir-up)
    (move-dir pos-2-6 pos-3-6 dir-right)
    (move-dir pos-3-4 pos-2-4 dir-left)
    (move-dir pos-3-4 pos-3-5 dir-down)
    (move-dir pos-3-4 pos-4-4 dir-right)
    (move-dir pos-3-5 pos-2-5 dir-left)
    (move-dir pos-3-5 pos-3-4 dir-up)
    (move-dir pos-3-5 pos-3-6 dir-down)
    (move-dir pos-3-5 pos-4-5 dir-right)
    (move-dir pos-3-6 pos-2-6 dir-left)
    (move-dir pos-3-6 pos-3-5 dir-up)
    (move-dir pos-3-6 pos-4-6 dir-right)
    (move-dir pos-4-2 pos-4-3 dir-down)
    (move-dir pos-4-2 pos-5-2 dir-right)
    (move-dir pos-4-3 pos-4-2 dir-up)
    (move-dir pos-4-3 pos-4-4 dir-down)
    (move-dir pos-4-3 pos-5-3 dir-right)
    (move-dir pos-4-4 pos-3-4 dir-left)
    (move-dir pos-4-4 pos-4-3 dir-up)
    (move-dir pos-4-4 pos-4-5 dir-down)
    (move-dir pos-4-5 pos-3-5 dir-left)
    (move-dir pos-4-5 pos-4-4 dir-up)
    (move-dir pos-4-5 pos-4-6 dir-down)
    (move-dir pos-4-5 pos-5-5 dir-right)
    (move-dir pos-4-6 pos-3-6 dir-left)
    (move-dir pos-4-6 pos-4-5 dir-up)
    (move-dir pos-4-6 pos-5-6 dir-right)
    (move-dir pos-5-2 pos-4-2 dir-left)
    (move-dir pos-5-2 pos-5-3 dir-down)
    (move-dir pos-5-2 pos-6-2 dir-right)
    (move-dir pos-5-3 pos-4-3 dir-left)
    (move-dir pos-5-3 pos-5-2 dir-up)
    (move-dir pos-5-3 pos-6-3 dir-right)
    (move-dir pos-5-5 pos-4-5 dir-left)
    (move-dir pos-5-5 pos-5-6 dir-down)
    (move-dir pos-5-5 pos-6-5 dir-right)
    (move-dir pos-5-6 pos-4-6 dir-left)
    (move-dir pos-5-6 pos-5-5 dir-up)
    (move-dir pos-5-6 pos-6-6 dir-right)
    (move-dir pos-6-2 pos-5-2 dir-left)
    (move-dir pos-6-2 pos-6-3 dir-down)
    (move-dir pos-6-3 pos-5-3 dir-left)
    (move-dir pos-6-3 pos-6-2 dir-up)
    (move-dir pos-6-5 pos-5-5 dir-left)
    (move-dir pos-6-5 pos-6-6 dir-down)
    (move-dir pos-6-6 pos-5-6 dir-left)
    (move-dir pos-6-6 pos-6-5 dir-up)
))
</pre></div>

            </div>
            <div class="mb-3">
                <form method="post" action="">
                    <label for="prompt" class="form-label"><strong>Prompt: </strong></label>
                    <textarea class="form-control" type="textarea" id="prompt" name="prompt" rows="3" autofocus>Allow player to go through walls</textarea>
                    <br>
                    <button class="btn btn-primary " type="submit">Submit</button>
                </form>
            </div>
        </div>
        <div class="container col-3">
            <img src="http://127.0.0.1:5000/simulation"/>
        </div>
    </div>
</body>
</html>
